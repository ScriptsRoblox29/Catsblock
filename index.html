<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catsblock</title>
    <meta name="description" content="CatsBlock is a messaging platform where you can send messages to other people. Try it now!" />

    <meta property="og:title" content="Catsblock" />
    <meta property="og:description" content="CatsBlock is a messaging platform where you can send messages to other people. Try it now!" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-black: #000000;
            --ios-card-bg: #1c1c1e;
            --ios-blue: #007AFF;
            --ios-red: #ff3b30;
            --ios-grey: #8e8e93;
            --ios-green: #34c759;
            --sent-gradient: linear-gradient(180deg, #007AFF 0%, #0056B3 100%);
            --received-bg: #262629;
            --blur-header: rgba(28, 28, 30, 0.85);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--bg-black);
            color: white; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            overflow: hidden;
        }

        /* --- NAVIGATION CONTROL --- */
        .app-view { display: none; height: 100vh; width: 100%; flex-direction: column; position: absolute; }
        .app-view.active { display: flex; }

        /* --- LOADING STATE --- */
        #view-loading { justify-content: center; align-items: center; z-index: 1000; }
        .ios-loader {
            width: 35px; height: 35px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--ios-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* --- LOGIN DESIGN --- */
        #view-login { justify-content: center; align-items: center; padding: 40px; text-align: center; }
        .login-container { animation: elasticIn 0.6s ease; }
        .btn-google {
            background: white; color: black; border: none; padding: 16px 28px;
            border-radius: 14px; font-weight: 600; font-size: 16px;
            display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 30px auto;
            transition: transform 0.2s;
        }
        .btn-google:active { transform: scale(0.95); }

        /* --- HEADER & LISTS --- */
        header {
            padding: 55px 20px 15px; background: var(--blur-header);
            backdrop-filter: blur(30px); border-bottom: 0.5px solid #38383a;
            display: flex; justify-content: space-between; align-items: center;
        }
        .skeleton-item {
            height: 75px; margin: 8px 15px; background: var(--ios-card-bg);
            border-radius: 15px; position: relative; overflow: hidden;
        }
        .skeleton-item::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
            animation: shimmer 1.5s infinite;
        }

        /* --- CHAT BUBBLES --- */
        #chat-scroller { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .message-row { display: flex; flex-direction: column; max-width: 78%; }
        .row-sent { align-self: flex-end; align-items: flex-end; }
        .row-received { align-self: flex-start; align-items: flex-start; }

        .bubble {
            padding: 11px 16px; border-radius: 20px; font-size: 16px; line-height: 1.35;
            animation: elasticIn 0.45s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            word-wrap: break-word;
        }
        .bubble.sent { background: var(--sent-gradient); border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.35); }
        .bubble.received { background: var(--received-bg); border-bottom-left-radius: 4px; }
        .msg-time { font-size: 10.5px; color: var(--ios-grey); margin-top: 5px; padding: 0 4px; }

        /* --- INPUT BAR --- */
        .input-container { padding: 10px 16px 36px; background: black; display: flex; align-items: flex-end; gap: 12px; }
        .textarea-box { flex: 1; background: var(--ios-card-bg); border-radius: 22px; padding: 6px 16px; border: 0.5px solid #38383a; }
        textarea {
            width: 100%; background: transparent; border: none; color: white;
            resize: none; font-size: 16px; max-height: 72px; padding: 8px 0; font-family: inherit;
        }

        /* --- BOTTOM NAV --- */
        .tab-bar {
            height: 88px; background: var(--blur-header); backdrop-filter: blur(30px);
            border-top: 0.5px solid #38383a; display: flex; justify-content: space-around; padding-top: 10px;
        }
        .tab-icon { color: var(--ios-grey); font-size: 22px; cursor: pointer; transition: 0.2s; }
        .tab-icon.active { color: var(--ios-blue); }

        /* --- PROFILE STYLES --- */
        .profile-container { flex: 1; overflow-y: auto; text-align: center; padding: 20px; }
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--ios-blue); margin-bottom: 15px; }
        .profile-info-box { background: var(--ios-card-bg); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .profile-label { color: var(--ios-grey); font-size: 12px; margin-bottom: 5px; text-transform: uppercase; }
        .profile-value { font-size: 16px; word-break: break-all; }
        .bio-textarea { width: 100%; background: transparent; border: none; color: white; font-size: 16px; font-family: inherit; resize: none; }

        /* --- SETTINGS SPECIFIC --- */
        .settings-row { display: flex; justify-content: space-between; align-items: center; }
        .ios-toggle {
            position: relative; width: 51px; height: 31px;
            background: #39393d; border-radius: 16px; cursor: pointer; transition: 0.3s;
        }
        .ios-toggle.active { background: var(--ios-green); }
        .ios-toggle::after {
            content: ''; position: absolute; width: 27px; height: 27px;
            background: white; border-radius: 50%; top: 2px; left: 2px;
            transition: 0.3s; box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .ios-toggle.active::after { left: 22px; }
        
        .blocked-user-card {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            background: var(--ios-card-bg); border-radius: 14px; margin-bottom: 10px;
        }
        .blocked-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .unblock-btn {
            margin-left: auto; color: var(--ios-blue); font-weight: 600;
            background: transparent; border: none; cursor: pointer;
        }

        /* --- IOS ALERTS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; justify-content: center;
            align-items: center; z-index: 2000; backdrop-filter: blur(6px);
        }
        .ios-modal {
            background: #1c1c1e; width: 280px; border-radius: 14px;
            text-align: center; animation: elasticIn 0.3s ease;
        }
        .modal-btn-group { display: flex; border-top: 0.5px solid #38383a; }
        .modal-btn { flex: 1; padding: 14px; border: none; background: transparent; color: var(--ios-blue); font-size: 17px; cursor: pointer; }
        .modal-btn.destructive { color: var(--ios-red); font-weight: 600; border-left: 0.5px solid #38383a; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        @keyframes elasticIn {
            0% { transform: scale(0.7); opacity: 0; filter: blur(8px); }
            100% { transform: scale(1); opacity: 1; filter: blur(0); }
        }
    </style>
</head>
<body>

    <div id="view-loading" class="app-view active">
        <div class="ios-loader"></div>
    </div>

    <div id="view-login" class="app-view">
        <div class="login-container">
            <h1 style="font-weight: 700; font-size: 28px;">Log in to access CatsBlock</h1>
            <button class="btn-google" id="google-auth-trigger">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="20">
                Continue with Google
            </button>
            <p style="font-size: 13px; color: var(--ios-grey); margin-top: 20px;">
                By continuing, you agree to our <br><a href="https://docs.google.com/document/d/1aB2LW5R3AuPpPiBvISFxS8d4ftbXWYa4TgAa-K_xwfI/edit?usp=drivesdk" style="color: var(--ios-blue); text-decoration: none;">terms of service</a>.
            </p>
        </div>
    </div>

    <div id="view-main" class="app-view">
        <header>
            <h1 style="font-size: 32px; font-weight: 700;">Messages</h1>
            <i class="fa-regular fa-pen-to-square" style="color: var(--ios-blue); font-size: 22px; cursor: pointer;" onclick="openNewConversation()"></i>
        </header>
        <div id="conversations-list" style="flex:1; overflow-y:auto;"></div>
        <nav class="tab-bar">
            <div class="tab-icon active"><i class="fa-solid fa-comment"></i></div>
            <div class="tab-icon" onclick="openUserProfile()"><i class="fa-solid fa-circle-user"></i></div>
        </nav>
    </div>

    <div id="view-my-profile" class="app-view">
        <header>
            <i class="fa-solid fa-chevron-left" style="color: var(--ios-blue); font-size: 20px; cursor:pointer;" onclick="setView('main')"></i>
            <h1 style="font-size: 20px; font-weight: 700;">My Profile</h1>
            <i class="fa-solid fa-gear" style="color: var(--ios-blue); font-size: 22px; cursor:pointer;" onclick="openSettings()"></i>
        </header>
        <div class="profile-container">
            <img id="my-profile-img" class="profile-avatar" src="">
            <div class="profile-info-box">
                <div class="profile-label">Display Name</div>
                <div id="my-profile-name" class="profile-value">---</div>
            </div>
            <div class="profile-info-box">
                <div class="profile-label">My User ID</div>
                <div id="my-profile-id" class="profile-value" style="color: var(--ios-blue); font-size: 14px;">---</div>
            </div>
            <div class="profile-info-box">
                <div class="profile-label">Bio / Description</div>
                <textarea id="my-profile-bio" class="bio-textarea" rows="4" placeholder="Update your bio..."></textarea>
            </div>
            <button onclick="saveMyBio()" style="background: var(--ios-blue); color: white; border: none; padding: 12px 30px; border-radius: 12px; font-weight: 600;">Save Bio</button>
        </div>
    </div>

    <div id="view-settings" class="app-view">
        <header>
            <i class="fa-solid fa-chevron-left" style="color: var(--ios-blue); font-size: 20px; cursor:pointer;" onclick="setView('myProfile')"></i>
            <h1 style="font-size: 20px; font-weight: 700;">Settings</h1>
            <div style="width: 20px;"></div>
        </header>
        <div class="profile-container">
            <div class="profile-info-box settings-row">
                <div style="font-weight: 500;">Accept new conversations</div>
                <div id="toggle-requests" class="ios-toggle active" onclick="toggleAcceptRequests()"></div>
            </div>
            
            <h2 style="text-align: left; font-size: 14px; color: var(--ios-grey); text-transform: uppercase; margin: 25px 5px 10px;">Blocked Users</h2>
            <div id="blocked-list-container"></div>
        </div>
    </div>
        <div id="view-chat" class="app-view">
        <header style="padding-top: 50px; justify-content: flex-start; gap: 15px;">
            <i class="fa-solid fa-chevron-left" style="color: var(--ios-blue); font-size: 20px; cursor:pointer;" onclick="navigateBack()"></i>
            <div style="flex:1; text-align: center; margin-right: 35px; cursor: pointer;" onclick="openContactInfo()">
                <div id="chat-contact-name" style="font-weight: 600; font-size: 17px;">Contact</div>
                <div style="font-size: 11px; color: var(--ios-grey);">Tap for info</div>
            </div>
        </header>
        <div id="chat-scroller"></div>
        <div class="input-container">
            <div class="textarea-box">
                <textarea id="main-textarea" placeholder="iMessage" rows="1"></textarea>
            </div>
            <button id="btn-send" style="background: var(--ios-blue); border:none; width:32px; height:32px; border-radius:50%; color:white; font-size: 18px; cursor:pointer;">â†‘</button>
        </div>
    </div>

    <div id="view-contact-info" class="app-view">
        <header>
            <i class="fa-solid fa-chevron-left" style="color: var(--ios-blue); font-size: 20px; cursor:pointer;" onclick="setView('chat')"></i>
            <h1 style="font-size: 20px; font-weight: 700;">Info</h1>
            <i class="fa-solid fa-ellipsis" style="color: var(--ios-blue); font-size: 20px; cursor:pointer;" onclick="toggleBlockModal(true)"></i>
        </header>
        <div class="profile-container">
            <img id="info-profile-img" class="profile-avatar" src="">
            <div class="profile-info-box">
                <div class="profile-label">Name</div>
                <div id="info-profile-name" class="profile-value">---</div>
            </div>
            <div class="profile-info-box">
                <div class="profile-label">User ID</div>
                <div id="info-profile-id" class="profile-value">---</div>
            </div>
            <div class="profile-info-box">
                <div class="profile-label">Bio</div>
                <div id="info-profile-bio" class="profile-value">---</div>
            </div>
        </div>
    </div>

    <div id="modal-block" class="modal-overlay">
        <div class="ios-modal">
            <div style="padding: 20px 16px 8px; font-weight: 600;">Block this person?</div>
            <div style="padding: 0 16px 20px; font-size: 13px; color: var(--ios-grey);">Are you sure you want to block that person?</div>
            <div class="modal-btn-group">
                <button class="modal-btn" onclick="toggleBlockModal(false)">Never mind</button>
                <button class="modal-btn destructive" onclick="handleUserBlock()">Block</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, updateDoc, getDoc, setDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy6Ewsq2egkBrELp6i9rGLRnvdIYqOxeg",
            authDomain: "catsblock-94c61.firebaseapp.com",
            projectId: "catsblock-94c61",
            storageBucket: "catsblock-94c61.firebasestorage.app",
            messagingSenderId: "462618239829",
            appId: "1:462618239829:web:8c1445e69db9fc988585dc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentActiveContactId = null;

        const views = {
            loading: document.getElementById('view-loading'),
            login: document.getElementById('view-login'),
            main: document.getElementById('view-main'),
            chat: document.getElementById('view-chat'),
            myProfile: document.getElementById('view-my-profile'),
            contactInfo: document.getElementById('view-contact-info'),
            settings: document.getElementById('view-settings')
        };

        function setView(viewId) {
            Object.values(views).forEach(v => v.classList.remove('active'));
            views[viewId].classList.add('active');
            if (viewId === 'main' && auth.currentUser) { bootstrapApp(); }
        }

        document.getElementById('google-auth-trigger').onclick = async () => {
            try { 
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                await setDoc(doc(db, "users", user.uid), {
                    name: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    bio: "Hello! I am using CatsBlock.",
                    acceptingRequests: true,
                    blockedList: []
                }, { merge: true });
            } 
            catch (err) { console.error("Login Error:", err); }
        };

        onAuthStateChanged(auth, (user) => { if (user) { bootstrapApp(); setView('main'); } else { setView('login'); } });
        

        async function bootstrapApp() {
            views.main.classList.add('active');
            const list = document.getElementById('conversations-list');
            list.innerHTML = Array(10).fill('<div class="skeleton-item"></div>').join('');
            setTimeout(() => {
                list.innerHTML = `<div style="text-align:center; padding:60px; color:var(--ios-grey); font-size: 15px;">
                    No conversation for now.<br>Click the pencil icon to start one!
                </div>`;
            }, 1800);
        }

        // --- SETTINGS LOGIC ---
        window.openSettings = async () => {
            const user = auth.currentUser;
            const snap = await getDoc(doc(db, "users", user.uid));
            const data = snap.data();
            
            const toggle = document.getElementById('toggle-requests');
            if(data.acceptingRequests) toggle.classList.add('active');
            else toggle.classList.remove('active');

            renderBlockedList(data.blockedList || []);
            setView('settings');
        };

        window.toggleAcceptRequests = async () => {
            const toggle = document.getElementById('toggle-requests');
            const newState = !toggle.classList.contains('active');
            await updateDoc(doc(db, "users", auth.currentUser.uid), { acceptingRequests: newState });
            toggle.classList.toggle('active');
        };

        async function renderBlockedList(list) {
            const container = document.getElementById('blocked-list-container');
            container.innerHTML = list.length ? "" : `<p style="color:var(--ios-grey); font-size: 13px;">No users blocked.</p>`;
            
            for (const uid of list) {
                const uSnap = await getDoc(doc(db, "users", uid));
                if (!uSnap.exists()) continue;
                const uData = uSnap.data();
                
                const div = document.createElement('div');
                div.className = 'blocked-user-card';
                div.innerHTML = `
                    <img src="${uData.photoURL}" class="blocked-img">
                    <div style="text-align: left;">
                        <div style="font-weight: 600; font-size: 14px;">${uData.name}</div>
                        <div style="font-size: 11px; color: var(--ios-grey);">${uid}</div>
                    </div>
                    <button class="unblock-btn" onclick="handleUnblock('${uid}')">Unblock</button>
                `;
                container.appendChild(div);
            }
        }
        window.handleUnblock = async (uid) => {
            await updateDoc(doc(db, "users", auth.currentUser.uid), {
                blockedList: arrayRemove(uid)
            });
            openSettings(); // Refresh view
        };

        // --- PROFILE & CHAT LOGIC ---
        window.openUserProfile = async () => {
            const user = auth.currentUser;
            const snap = await getDoc(doc(db, "users", user.uid));
            const data = snap.data();
            document.getElementById('my-profile-img').src = user.photoURL;
            document.getElementById('my-profile-name').innerText = data.name;
            document.getElementById('my-profile-id').innerText = user.uid;
            document.getElementById('my-profile-bio').value = data.bio || "";
            setView('myProfile');
        };

        window.saveMyBio = async () => {
            const newBio = document.getElementById('my-profile-bio').value;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { bio: newBio });
            alert("Bio updated!");
        };

        window.openContactInfo = async () => {
            if(!currentActiveContactId) return;
            const snap = await getDoc(doc(db, "users", currentActiveContactId));
            const data = snap.data();
            document.getElementById('info-profile-img').src = data.photoURL || "";
            document.getElementById('info-profile-name').innerText = data.name;
            document.getElementById('info-profile-id').innerText = currentActiveContactId;
            document.getElementById('info-profile-bio').innerText = data.bio || "No description.";
            setView('contactInfo');
        };

        window.openNewConversation = async () => {
            const targetId = prompt("Enter User ID:");
            if(!targetId) return;
            const myId = auth.currentUser.uid;
            if(targetId === myId) { alert("You cannot start a conversation with yourself."); return; }
            try {
                const userSnap = await getDoc(doc(db, "users", targetId));
                if(!userSnap.exists()) { alert("User ID not found."); return; }
                const userData = userSnap.data();
                if(userData.acceptingRequests === false) { alert("This user is not accepting new requests."); return; }
                if(userData.blockedList && userData.blockedList.includes(myId)) { alert("You cannot message this user."); return; }
                currentActiveContactId = targetId;
                document.getElementById('chat-contact-name').innerText = userData.name;
                setView('chat');
            } catch (err) { alert("Error connecting."); }
        };

        window.handleUserBlock = async () => {
            if(!currentActiveContactId) return;
            await updateDoc(doc(db, "users", auth.currentUser.uid), { blockedList: arrayUnion(currentActiveContactId) });
            alert("User blocked.");
            window.toggleBlockModal(false);
            setView('main');
        };

        const textarea = document.getElementById('main-textarea');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 72) + 'px';
        });

        async function postMessage() {
            const rawText = textarea.value.trim();
            if (rawText.length < 1) return;
            renderBubble({ content: rawText, createdAt: null }, 'sent');
            textarea.value = "";
            textarea.style.height = 'auto';
        }

        function renderBubble(data, mode) {
            const scroller = document.getElementById('chat-scroller');
            const row = document.createElement('div');
            row.className = `message-row row-${mode}`;
            row.innerHTML = `<div class="bubble ${mode}">${data.content}</div><div class="msg-time">Now</div>`;
            scroller.appendChild(row);
            scroller.scrollTop = scroller.scrollHeight;
        }

        document.getElementById('btn-send').onclick = postMessage;
        window.setView = setView;
        window.navigateBack = () => setView('main');
        window.toggleBlockModal = (show) => document.getElementById('modal-block').style.display = show ? 'flex' : 'none';
    </script>
</body>
</html>
